---
title: "数据爬取"
output: html_notebook
---

## 爬取需求
其实这件事逻辑关系不复杂，主要就是从三家网站搜集数据。是关于印度电影的。三家网站分别是[IMDb](IMDb.com),[BOI](www.boxofficeindia.com),和[wiki](https://en.wikipedia.org/wiki/Wiki) 。具体如下，1，boxofficeindia 有 success count banner /hit count banner(电影制片方和发行方），每一家上榜公司会有制作发行过的相关电影，每一部电影会有首映日，类型，票房，导演，制片，等等等等-相关信息，需要搜索所有上榜公司的所有影片的一切相关信息。大概是900左右影片。2.同样一部电影，在IMDb也都会有相关信息，而且信息上还有出入，可以用boxofficeIndia的影片来相关搜索，然后搜集关于这部电影的信息。3.维基百科也可能会有相关的电影信息（但是不是所有都有）有的话请搜集。

# BOI 网页爬取
```{r}
library(rvest)
# 分析单个网页，PK电影
url<-"http://www.boxofficeindia.com/movie.php?movieid=2482"
web<-read_html(url)

# search the element
movie_name<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div.bl_tle_mvi.blue_tlte > a") %>% html_text()

release_date<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div:nth-child(2) > span.redtext") %>% html_text()

Runtime<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div:nth-child(2)") %>% html_text()
Runtime<-strsplit(Runtime,split = c("[|]"))[[1]][2]
Runtime<-strsplit(Runtime,split = c(":"))[[1]][2]

Genre<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div:nth-child(2) > a:nth-child(5)") %>% html_text()

all_name<-c("Movie","Release date","Runtime","Genre")
all_value<-c(movie_name,release_date,Runtime,Genre)

# director
Table1<-web %>% html_nodes("table.actrsmovie") %>% html_table(fill=TRUE)
## for full information
url_split<-strsplit(url,split = '[?]')[[1]][2]
full_url<-paste("http://www.boxofficeindia.com/cast_crew.php?",url_split,sep='')
web_full<-read_html(full_url)

director<-web_full %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div.movieboxsleftouter.bluelink > div.movieboxsright > div:nth-child(4) > div > div > table") %>% html_table()

director<-director[[1]]
all_name<-c(all_name,director$X1)
all_value<-c(all_vallue,director$X2)
all_value<-gsub('[\t\r\n]',',',all_value)


cast_table<-web_full %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div.moviegraybox.bluelink > table") %>% html_table(fill=TRUE)
cast_table<-cast_table[[1]]$X1
cast_table[cast_table==""]<-NA
cast_table<-na.omit(cast_table)

all_name<-c(all_name,"cast")
all_value<-c(all_value,paste(cast_table,collapse = ','))

# main content
Table2<-web %>% html_nodes("table.mviedtailstbe") %>% html_table(fill=TRUE)

table2_name<-c(Table2[[1]]$X1,Table2[[2]]$X1,Table2[[4]]$X1,Table2[[5]]$X1,Table2[[6]]$X1,Table2[[7]]$X1,Table2[[8]]$X1)
table2_name[table2_name==""]<-NA
table2_value<-c(Table2[[1]]$X3,Table2[[2]]$X3,Table2[[4]]$X3,Table2[[5]]$X3,Table2[[6]]$X3,Table2[[7]]$X3,Table2[[8]]$X3)

table2_name<-na.omit(table2_name)
table2_value<-na.omit(table2_value)

all_name<-c(all_name,table2_name)
all_value<-c(all_value,table2_value)

# 票房
Table3<-web %>% html_nodes("table.hide_in_mobile") %>% html_table(fill=TRUE)
Table3_name<-c(Table3[[1]]$X1[1],Table3[[1]]$X2[1],Table3[[1]]$X3[1],Table3[[1]]$X4[1])
Table3_value<-c(Table3[[1]]$X1[2],Table3[[1]]$X2[2],Table3[[1]]$X3[2],Table3[[1]]$X4[2])
all_name<-c(all_name,Table3_name)
all_value<-c(all_value,Table3_value)

# production banner
production_banner<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div.movieboxssec.bluelink.movieim7.pro_cst_cls") %>% html_text()
banner<-strsplit(production_banner,split='\n')
banner_name<-banner[[1]][1]
banner_value<-banner[[1]][2]
banner_value<-gsub('[|]','\t',banner_value)
all_name<-c(all_name,banner_name)
all_value<-c(all_value,banner_value)

# 各地票房
Table4<-web %>% html_nodes("div.boxlisting2.bluelink.firstrow > table") %>% html_table(fill=TURE)
Table4_name<-NULL
Table4_value<-NULL
for(i in 1:length(Table4)){
    # 显示票房
    Table4_name<-c(Table4_name,paste("Collection ",Table4[[i]]$X1[1],sep=''))
    Table4_value<-c(Table4_value,Table4[[i]]$X1[2])
  # Table4_name<-c(Table4_name,Table4[[i]]$X1[1])
  # Table4_value<-c(Table4_value,Table4[[i]]$X1[2])
}

all_name<-c(all_name,Table4_name)
all_value<-c(all_value,Table4_value)

dataAll<-data.frame("name"=all_name,"value"=all_value)
write.csv(dataAll,file = "dataAll.csv")

# 主演
# Table5<-web %>% html_nodes("#adafter3") %>% html_table(fill=TURE)


```
## 读取不同hit banner下面的电影
```{r}
banner_url<-'http://www.boxofficeindia.com/hit-count-banner.php'
web_banner<-read_html(banner_url)

# 无法加载全部资源，导致无法找到元素
url_banner_alone<-web_banner %>% html_nodes("#yeartopim4 > table > tbody > tr > td > table > tbody > tr > td > a") %>% html_attr("href")

# 模拟浏览器,找到所有电影公司
library(seleniumPipes)
library(rvest)
library(dplyr)
library(stringi)
library(purrr)

remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
remDr %>% go(banner_url)
remDr %>% getPageSource() -> web_banner
url_banner_alone<-web_banner %>% html_nodes("#yeartopim4 > table > tbody > tr > td > table > tbody > tr > td > a") %>% html_attr("href")

url_banner_alone<-url_banner_alone[!duplicated(url_banner_alone)]

url_banner_alone<-paste("http://www.boxofficeindia.com/",url_banner_alone,sep="")

# web_banner_alone<-url_banner_alone[1]
# remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
# remDr %>% setTimeout(type = "implicit", 5000)
# remDr %>% go(web_banner_alone)
# remDr %>% getPageSource() -> web_banner_alone

# web_banner_test<-url_banner_alone[1]
# web_banner_alone<-read_html(web_banner_test)
# movie_url<-web_banner_alone %>% html_nodes("#yeartopim4 > table > tbody > tr> td> table > tbody > tr > td:nth-child(2) > a") %>% html_attr('href')

# 找到所有的电影
movie_url_all<-NULL
for(i in 1:length(url_banner_alone)){
  web_banner_test<-url_banner_alone[i]
  web_banner_alone<-read_html(web_banner_test)
  movie_url<-web_banner_alone %>% html_nodes("tr > td:nth-child(2) > a") %>% html_attr('href')
  movie_url_all<-c(movie_url_all,movie_url)
}
# 去掉重复的电影
movie_url_all<-movie_url_all[!duplicated(movie_url_all)]
movie_url_all<-paste("http://www.boxofficeindia.com/",movie_url_all,sep="")
## 可能会包含有banner，去除banner
movie_url_clean<-movie_url_all[!grepl("banner",movie_url_all)]
```
## 写成函数
为了方便爬取，将上诉过程写成函数，只要输入电影的url就可以下载所有信息
```{r}
run_movie_boi<-function(url){
  library(rvest)
  # 分析单个网页，PK电影
  # url<-"http://www.boxofficeindia.com/movie.php?movieid=2482"
  web<-read_html(url)
  
  # search the element
  movie_name<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div.bl_tle_mvi.blue_tlte > a") %>% html_text()
  
  release_date<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div:nth-child(2) > span.redtext") %>% html_text()
  
  Runtime<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div:nth-child(2)") %>% html_text()
  Runtime<-strsplit(Runtime,split = c("[|]"))[[1]][2]
  Runtime<-strsplit(Runtime,split = c(":"))[[1]][2]
  
  Genre<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsright > div:nth-child(2) > a:nth-child(5)") %>% html_text()
  
  all_name<-c("Movie","Release date","Runtime","Genre")
  all_value<-c(movie_name,release_date,Runtime,Genre)
  
  # director
  Table1<-web %>% html_nodes("table.actrsmovie") %>% html_table(fill=TRUE)
  ## for full information
  url_split<-strsplit(url,split = '[?]')[[1]][2]
  full_url<-paste("http://www.boxofficeindia.com/cast_crew.php?",url_split,sep='')
  web_full<-read_html(full_url)
  
  director<-web_full %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div.movieboxsleftouter.bluelink > div.movieboxsright > div:nth-child(4) > div > div > table") %>% html_table()
  
  director<-director[[1]]
  all_name<-c(all_name,director$X1)
  all_value<-c(all_value,director$X2)
  all_value<-gsub('[\t\r\n]',',',all_value)
  
  
  cast_table<-web_full %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div.moviegraybox.bluelink > table") %>% html_table(fill=TRUE)
  cast_table<-cast_table[[1]]$X1
  cast_table[cast_table==""]<-NA
  cast_table<-na.omit(cast_table)
  
  all_name<-c(all_name,"cast")
  all_value<-c(all_value,paste(cast_table,collapse = ','))
  
  # main content
  Table2<-web %>% html_nodes("table.mviedtailstbe") %>% html_table(fill=TRUE)
  
  table2_name<-c(Table2[[1]]$X1,Table2[[2]]$X1,Table2[[4]]$X1,Table2[[5]]$X1,Table2[[6]]$X1,Table2[[7]]$X1,Table2[[8]]$X1)
  table2_name[table2_name==""]<-NA
  table2_value<-c(Table2[[1]]$X3,Table2[[2]]$X3,Table2[[4]]$X3,Table2[[5]]$X3,Table2[[6]]$X3,Table2[[7]]$X3,Table2[[8]]$X3)
  
  table2_name<-na.omit(table2_name)
  table2_value<-na.omit(table2_value)
  
  all_name<-c(all_name,table2_name)
  all_value<-c(all_value,table2_value)
  
  # 票房
  Table3<-web %>% html_nodes("table.hide_in_mobile") %>% html_table(fill=TRUE)
  Table3_name<-c(Table3[[1]]$X1[1],Table3[[1]]$X2[1],Table3[[1]]$X3[1],Table3[[1]]$X4[1])
  Table3_value<-c(Table3[[1]]$X1[2],Table3[[1]]$X2[2],Table3[[1]]$X3[2],Table3[[1]]$X4[2])
  all_name<-c(all_name,Table3_name)
  all_value<-c(all_value,Table3_value)
  
  # production banner
  production_banner<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div.movieboxssec.bluelink.movieim7.pro_cst_cls") %>% html_text()
  banner<-strsplit(production_banner,split='\n')
  banner_name<-banner[[1]][1]
  banner_value<-banner[[1]][2]
  banner_value<-gsub('[|]','\t',banner_value)
  all_name<-c(all_name,banner_name)
  all_value<-c(all_value,banner_value)
  
  # 各地票房
  Table4<-web %>% html_nodes("div.boxlisting2.bluelink.firstrow > table") %>% html_table(fill=TURE)
  Table4_name<-NULL
  Table4_value<-NULL
  for(i in 1:length(Table4)){
    # 显示票房
    Table4_name<-c(Table4_name,paste("Collection ",Table4[[i]]$X1[1],sep=''))
    Table4_value<-c(Table4_value,Table4[[i]]$X1[2])
  }
  
   # 增加User Verdict
  User_Verdict<-"User Verdict"
  User_Verdict_value<-web %>% html_nodes("#bodybox > div.innersections2 > div.innersec > div.latestre > div:nth-child(1) > div.movieboxsleft.moviepcposter > div > strong") %>% html_text()
  
  all_name<-c(all_name,User_Verdict)
  all_value<-c(all_value,User_Verdict_value)
  
  all_name<-c(all_name,Table4_name)
  all_value<-c(all_value,Table4_value)
  
  dataAll<-data.frame("name"=all_name,"value"=all_value)
  
  return(dataAll)
}
```

## 收集数据
```{r}
finalData<-run_movie_boi(movie_url_clean[1])
for(i in 2:length(movie_url_clean)){
  # 判断是否出错
  processData<-try(run_movie_boi(movie_url_clean[i]))
  # 如果出错则去除
  if(!inherits(processData,'try-error')){
    finalData<-merge(finalData,processData,by="name",all=TRUE)
  }
  cat(i,"\n")
  save(finalData,file="finalData.Rdata")
}


write.csv(finalData,file="finalData.csv",row.names = FALSE)
```

## 读取不同success banner下的电影
```{r}
success_url<-"http://www.boxofficeindia.com/success-count-banner.php"

# 模拟浏览器,找到所有电影公司
library(seleniumPipes)
library(rvest)
library(dplyr)
library(stringi)
library(purrr)

remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
remDr %>% go(success_url)
remDr %>% getPageSource() -> success_banner
success_banner_alone<-success_banner %>% html_nodes("#yeartopim4 > table > tbody > tr > td > table > tbody > tr > td > a") %>% html_attr("href")

success_banner_alone<-success_banner_alone[!duplicated(success_banner_alone)]

success_banner_alone<-paste("http://www.boxofficeindia.com/",success_banner_alone,sep="")

# web_banner_alone<-url_banner_alone[1]
# remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
# remDr %>% setTimeout(type = "implicit", 5000)
# remDr %>% go(web_banner_alone)
# remDr %>% getPageSource() -> web_banner_alone

# web_banner_test<-url_banner_alone[1]
# web_banner_alone<-read_html(web_banner_test)
# movie_url<-web_banner_alone %>% html_nodes("#yeartopim4 > table > tbody > tr> td> table > tbody > tr > td:nth-child(2) > a") %>% html_attr('href')

# 找到所有的电影
success_movie_url_all<-NULL
for(i in 1:length(success_banner_alone)){
  web_banner_test<-success_banner_alone[i]
  web_banner_alone<-read_html(web_banner_test)
  movie_url<-web_banner_alone %>% html_nodes("tr > td:nth-child(2) > a") %>% html_attr('href')
  success_movie_url_all<-c(success_movie_url_all,movie_url)
}
# 去掉重复的电影
success_movie_url_all<-success_movie_url_all[!duplicated(success_movie_url_all)]
success_movie_url_all<-paste("http://www.boxofficeindia.com/",success_movie_url_all,sep="")
## 可能会包含有banner，去除banner
success_movie_url_clean<-success_movie_url_all[!grepl("banner",success_movie_url_all)]

# 去除与hit banner相同的部分
include_url<-success_movie_url_clean %in% movie_url_clean
movie_url_clean_rest<-success_movie_url_clean[!include_url]


for(i in 1:length(movie_url_clean_rest)){
  # 判断是否出错
  processData<-try(run_movie_boi(movie_url_clean_rest[i]))
  # 如果出错则去除,有些项某些电影没有，合并的时候需要保留全部，merge添加参数all=TRUE
  if(!inherits(processData,'try-error')){
    finalData<-merge(finalData,processData,by="name",all=TRUE)
  }
  cat(i,"\n")
  save(finalData,file="finalData.Rdata")
}

```

# IMDB网页爬取
首先，从BOI获取所有印度公司的名称
```{r}
# 爬取电影公司名称hit banner
library(rvest)
url<-"http://www.boxofficeindia.com/hit-count-banner.php"
web<-read_html(url)
banner_name<-web %>% html_nodes("table.bluelink") %>% html_table(fill=TRUE)
name_of_banner_hit<-banner_name[[1]]$X2
name_of_banner_hit<-name_of_banner_hit[2:length(name_of_banner_hit)]
name_of_banner_hit<-name_of_banner_hit[!duplicated(name_of_banner_hit)]

# 爬取电影公司名称success banner
library(rvest)
url<-"http://www.boxofficeindia.com/success-count-banner.php"
web<-read_html(url)
banner_name<-web %>% html_nodes("table.bluelink") %>% html_table(fill=TRUE)
name_of_banner_success<-banner_name[[1]]$X2
name_of_banner_success<-name_of_banner_success[2:length(name_of_banner_success)]
name_of_banner_success<-name_of_banner_success[!duplicated(name_of_banner_success)]

# 合并所有公司
name_of_banner<-c(name_of_banner_hit,name_of_banner_success)
name_of_banner<-name_of_banner[!duplicated(name_of_banner)]
```

## 输入电影公司查询电影的相关信息
```{r}
# 提取单个电影网页的信息
movie_url_single<-"http://www.imdb.com/title/tt2389974/"
web_movie<-read_html(movie_url_single,encoding = "UTF-8")

all_name<-NULL
all_value<-NULL
# 提取电影名称以及评分
movie_name<-web_movie %>% html_nodes(xpath='//*[@id="title-overview-widget"]/div[2]/div[2]/div/div[2]/div[2]/h1/text()') %>% html_text()
movie_name<-gsub('&nbsp','',movie_name[grepl('[a-z]',movie_name)])

movie_score<-web_movie %>% html_nodes('#title-overview-widget > div.vital > div.title_block > div > div.ratings_wrapper > 
                                      div.imdbRating > div.ratingValue > strong > span') %>% html_text()
movie_rating_user<-web_movie %>% html_nodes('#title-overview-widget > div.vital > div.title_block > 
                                            div > div.ratings_wrapper > div.imdbRating > a > span') %>% html_text()
all_name<-c(all_name,"Movie","IMBD rating value","rating user count")
all_value<-c(all_value,movie_name,movie_score,movie_rating_user)

# 提取所有演职员的信息
full_cast<-web_movie %>% html_nodes("#titleCast > div > a") %>% html_attr('href')
full_cast_url<-paste(movie_url_single,full_cast,sep='')

web_cast<-read_html(full_cast_url)

## cast_crew
content<-web_cast %>% html_nodes('#fullcredits_content > h4') %>% html_text()
content<-gsub('[\n]','',content)
content_table<-web_cast %>% html_nodes('#fullcredits_content > table') %>% html_table(fill=TRUE)
content_collapse<-c(1:length(content_table))
for(i in 1:length(content_table)){
  content_collapse[i]<-paste(content_table[[i]]$X1,collapse = ',')
}
content_collapse[3]<-paste(na.omit(content_table[[3]]$X2),collapse = ',')

all_name<-c(all_name,content)
all_value<-c(all_value,content_collapse)

# 提取所有 plot keywords
full_keywords<-web_movie %>% html_nodes('#titleStoryLine > div:nth-child(6) > nobr > a') %>% html_attr('href')
full_keywords_url<-paste("http://www.imdb.com/",full_keywords,sep='')

web_keywords<- read_html(full_keywords_url)
keywords<-web_keywords %>% html_nodes('#keywords_content > table > tbody > tr > td > div.sodatext > a') %>% html_text()
all_name<-c(all_name,'Plot_keywords')
all_value<-c(all_value,paste(keywords,collapse = ','))

# 提取所有公司的信息
full_company <- web_movie %>% html_nodes('#titleDetails > div:nth-child(14) > span.see-more.inline > a') %>% html_attr('href')
full_company_url<-paste(movie_url_single,full_company,sep='')

web_company<-read_html(full_company_url)
company<-web_company %>% html_nodes('#company_credits_content > h4') %>% html_text()
company_table<-web_company %>% html_nodes('#company_credits_content > ul') %>% html_text()
# 将首字母变为大写
company_table<-gsub(pattern = "\\b([a-z])", replacement = "\\U\\1", company_table, perl = TRUE)
# 去掉公司信息空格
company_table<-gsub('[" "]',"",company_table)
# 将单词分开，利用首字母大写
company_table<-gsub('([[:upper:]])', ' \\1', company_table)
company_collapse<-unlist(lapply(company_table,function(x){
  company_clean<-unlist(strsplit(x,split = '\n'))
  company_clean[company_clean==""]<-NA
  company_clean<-na.omit(company_clean)
  company_clean_after<-paste(company_clean,collapse = ',')
}))
company_collapse<-gsub('- ',"-",company_collapse)
# library(Hmisc)
# capitalize("it is test")
all_name<-c(all_name,company)
all_value<-c(all_value,company_collapse)

# 主页面元素
tagLines<-web_movie %>% html_nodes('#titleStoryLine > div') %>% html_text()
# 获取需要的两列Taglines 和 Genres
tagLines<-tagLines[grepl('Taglines|Genres',tagLines)]
Taglines<-gsub('\n','',strsplit(tagLines,split=':')[[1]][2])
Genres<-gsub('\n','',strsplit(tagLines,split=':')[[2]][2])

all_name<-c(all_name,"Taglines","Genres")
all_value<-c(all_value,Taglines,Genres)

# 获取其他元素
details<-web_movie %>% html_nodes('#titleDetails > div') %>% html_text()
detail_name<-c(1:length(details))
detail_value<-c(1:length(details))
for(i in 1:length(details)){
  detail_name[i]<-gsub('\n','',strsplit(details[i],split=':')[[1]][1])
  detail_value[i]<-gsub('\n','',strsplit(details[i],split=':')[[1]][2])
}

all_name<-c(all_name,detail_name)
all_value<-c(all_value,detail_value)
# 去除‘See more »’
all_value<-gsub('»|See more','',all_value)

data_return<-data.frame("name"=all_name,"value"=all_value)
```
为了方便，将上面文件写成一个函数
```{r}
run_IMDb<-function(movie_url_single){
  # 提取单个电影网页的信息
  # movie_url_single<-"http://www.imdb.com/title/tt2389974/"
  web_movie<-read_html(movie_url_single,encoding = "UTF-8")
  
  all_name<-NULL
  all_value<-NULL
  # 提取电影名称以及评分
  movie_name<-web_movie %>% html_nodes(xpath='//*[@id="title-overview-widget"]/div[2]/div[2]/div/div[2]/div[2]/h1/text()') %>% html_text()
  movie_name<-gsub('&nbsp','',movie_name[grepl('[a-z]',movie_name)])
  
  movie_score<-web_movie %>% html_nodes('#title-overview-widget > div.vital > div.title_block > div > div.ratings_wrapper > 
                                        div.imdbRating > div.ratingValue > strong > span') %>% html_text()
  movie_rating_user<-web_movie %>% html_nodes('#title-overview-widget > div.vital > div.title_block > 
                                              div > div.ratings_wrapper > div.imdbRating > a > span') %>% html_text()
  all_name<-c(all_name,"Movie","IMBD rating value","rating user count")
  all_value<-c(all_value,movie_name,movie_score,movie_rating_user)
  
  # 提取所有演职员的信息
  full_cast<-web_movie %>% html_nodes("#titleCast > div > a") %>% html_attr('href')
  full_cast_url<-paste(movie_url_single,full_cast,sep='')
  
  #titleCast > div > a

  web_cast<-read_html(full_cast_url)
  
  ## cast_crew
  content<-web_cast %>% html_nodes('#fullcredits_content > h4') %>% html_text()
  content<-gsub('[\n]','',content)
  content_table<-web_cast %>% html_nodes('#fullcredits_content > table') %>% html_table(fill=TRUE)
  content_collapse<-c(1:length(content_table))
  for(i in 1:length(content_table)){
    content_collapse[i]<-paste(content_table[[i]]$X1,collapse = ',')
  }
  content_collapse[3]<-paste(na.omit(content_table[[3]]$X2),collapse = ',')
  
  all_name<-c(all_name,content)
  all_value<-c(all_value,content_collapse)
  
  # 提取所有 plot keywords
  full_keywords<-web_movie %>% html_nodes('#titleStoryLine > div:nth-child(6) > nobr > a') %>% html_attr('href')
  full_keywords_url<-paste("http://www.imdb.com/",full_keywords,sep='')
  
  web_keywords<- read_html(full_keywords_url)
  keywords<-web_keywords %>% html_nodes('#keywords_content > table > tbody > tr > td > div.sodatext > a') %>% html_text()
  all_name<-c(all_name,'Plot_keywords')
  all_value<-c(all_value,paste(keywords,collapse = ','))
  
  # 提取所有公司的信息
  full_company <- web_movie %>% html_nodes('#titleDetails > div:nth-child(14) > span.see-more.inline > a') %>% html_attr('href')
  full_company_url<-paste(movie_url_single,full_company,sep='')
  
  web_company<-read_html(full_company_url)
  company<-web_company %>% html_nodes('#company_credits_content > h4') %>% html_text()
  company_table<-web_company %>% html_nodes('#company_credits_content > ul') %>% html_text()
  # 将首字母变为大写
  company_table<-gsub(pattern = "\\b([a-z])", replacement = "\\U\\1", company_table, perl = TRUE)
  # 去掉公司信息空格
  company_table<-gsub('[" "]',"",company_table)
  # 将单词分开，利用首字母大写
  company_table<-gsub('([[:upper:]])', ' \\1', company_table)
  company_collapse<-unlist(lapply(company_table,function(x){
    company_clean<-unlist(strsplit(x,split = '\n'))
    company_clean[company_clean==""]<-NA
    company_clean<-na.omit(company_clean)
    company_clean_after<-paste(company_clean,collapse = ',')
  }))
  company_collapse<-gsub('- ',"-",company_collapse)
  # library(Hmisc)
  # capitalize("it is test")
  all_name<-c(all_name,company)
  all_value<-c(all_value,company_collapse)
  
  # 主页面元素
  tagLines<-web_movie %>% html_nodes('#titleStoryLine > div') %>% html_text()
  # 获取需要的两列Taglines 和 Genres
  tagLines<-tagLines[grepl('Taglines|Genres',tagLines)]
  Taglines<-gsub('\n','',strsplit(tagLines,split=':')[[1]][2])
  Genres<-gsub('\n','',strsplit(tagLines,split=':')[[2]][2])
  
  all_name<-c(all_name,"Taglines","Genres")
  all_value<-c(all_value,Taglines,Genres)
  
  # 获取其他元素
  details<-web_movie %>% html_nodes('#titleDetails > div') %>% html_text()
  detail_name<-c(1:length(details))
  detail_value<-c(1:length(details))
  for(i in 1:length(details)){
    detail_name[i]<-gsub('\n','',strsplit(details[i],split=':')[[1]][1])
    detail_value[i]<-gsub('\n','',strsplit(details[i],split=':')[[1]][2])
  }
  
  all_name<-c(all_name,detail_name)
  all_value<-c(all_value,detail_value)
  # 去除‘See more »’
  all_value<-gsub('»|See more','',all_value)
  
  data_return<-data.frame("name"=all_name,"value"=all_value)
  return(data_return)
}
```
因为电影类型不同，可能结构上有些不一样，所以修改了一下，删除了tagLine
```{r}
run_IMDb<-function(movie_url_single){
  # 提取单个电影网页的信息
  # movie_url_single<-"http://www.imdb.com/title/tt2389974/"
  web_movie<-read_html(movie_url_single,encoding = "UTF-8")
  
  all_name<-NULL
  all_value<-NULL
  # 提取电影名称以及评分
  movie_name<-web_movie %>% html_nodes(xpath='//*[@id="title-overview-widget"]/div[2]/div[2]/div/div[2]/div[2]/h1/text()') %>% html_text()
  movie_name<-gsub('&nbsp','',movie_name[grepl('[a-z]',movie_name)])
  
  movie_score<-web_movie %>% html_nodes('#title-overview-widget > div.vital > div.title_block > div > div.ratings_wrapper > 
                                        div.imdbRating > div.ratingValue > strong > span') %>% html_text()
  movie_rating_user<-web_movie %>% html_nodes('#title-overview-widget > div.vital > div.title_block > 
                                              div > div.ratings_wrapper > div.imdbRating > a > span') %>% html_text()
  all_name<-c(all_name,"Movie","IMBD rating value","rating user count")
  all_value<-c(all_value,movie_name,movie_score,movie_rating_user)
  
  # 提取所有演职员的信息
  full_cast<-web_movie %>% html_nodes("#titleCast > div > a") %>% html_attr('href')
  full_cast_url<-paste(movie_url_single,full_cast,sep='')
  
  #titleCast > div > a

  web_cast<-read_html(full_cast_url)
  
  ## cast_crew
  content<-web_cast %>% html_nodes('#fullcredits_content > h4') %>% html_text()
  content<-gsub('[\n]','',content)
  content_table<-web_cast %>% html_nodes('#fullcredits_content > table') %>% html_table(fill=TRUE)
  content_collapse<-c(1:length(content_table))
  for(i in 1:length(content_table)){
    content_collapse[i]<-paste(content_table[[i]]$X1,collapse = ',')
  }
  content_collapse[3]<-paste(na.omit(content_table[[3]]$X2),collapse = ',')
  
  all_name<-c(all_name,content)
  all_value<-c(all_value,content_collapse)
  
  # 提取所有 plot keywords
  full_keywords<-web_movie %>% html_nodes('#titleStoryLine > div:nth-child(6) > nobr > a') %>% html_attr('href')
  full_keywords_url<-paste("http://www.imdb.com/",full_keywords,sep='')
  
  web_keywords<- read_html(full_keywords_url)
  keywords<-web_keywords %>% html_nodes('#keywords_content > table > tbody > tr > td > div.sodatext > a') %>% html_text()
  all_name<-c(all_name,'Plot_keywords')
  all_value<-c(all_value,paste(keywords,collapse = ','))
  
  # 提取所有公司的信息
  full_company <- web_movie %>% html_nodes('#titleDetails > div:nth-child(14) > span.see-more.inline > a') %>% html_attr('href')
  full_company_url<-paste(movie_url_single,full_company,sep='')
  
  web_company<-read_html(full_company_url)
  company<-web_company %>% html_nodes('#company_credits_content > h4') %>% html_text()
  company_table<-web_company %>% html_nodes('#company_credits_content > ul') %>% html_text()
  # 将首字母变为大写
  company_table<-gsub(pattern = "\\b([a-z])", replacement = "\\U\\1", company_table, perl = TRUE)
  # 去掉公司信息空格
  company_table<-gsub('[" "]',"",company_table)
  # 将单词分开，利用首字母大写
  company_table<-gsub('([[:upper:]])', ' \\1', company_table)
  company_collapse<-unlist(lapply(company_table,function(x){
    company_clean<-unlist(strsplit(x,split = '\n'))
    company_clean[company_clean==""]<-NA
    company_clean<-na.omit(company_clean)
    company_clean_after<-paste(company_clean,collapse = ',')
  }))
  company_collapse<-gsub('- ',"-",company_collapse)
  # library(Hmisc)
  # capitalize("it is test")
  all_name<-c(all_name,company)
  all_value<-c(all_value,company_collapse)
  
  # 主页面元素
  tagLines<-web_movie %>% html_nodes('#titleStoryLine > div') %>% html_text()
  # 获取需要的两列Taglines 和 Genres
  # tagLines<-tagLines[grepl('Taglines|Genres',tagLines)]
  # Taglines<-gsub('\n','',strsplit(tagLines,split=':')[[1]][2])
  # Genres<-gsub('\n','',strsplit(tagLines,split=':')[[2]][2])
  
  # 获取Genres
  tagLines<-tagLines[grepl('Genres',tagLines)]
  Genres<-gsub('\n','',strsplit(tagLines,split=':')[[1]][2])
  
  # all_name<-c(all_name,"Taglines","Genres")
  # all_value<-c(all_value,Taglines,Genres)
  all_name<-c(all_name,"Genres")
  all_value<-c(all_value,Genres)
  
  # 获取其他元素
  details<-web_movie %>% html_nodes('#titleDetails > div') %>% html_text()
  detail_name<-c(1:length(details))
  detail_value<-c(1:length(details))
  for(i in 1:length(details)){
    detail_name[i]<-gsub('\n','',strsplit(details[i],split=':')[[1]][1])
    detail_value[i]<-gsub('\n','',strsplit(details[i],split=':')[[1]][2])
  }
  
  all_name<-c(all_name,detail_name)
  all_value<-c(all_value,detail_value)
  # 去除‘See more »’
  all_value<-gsub('»|See more','',all_value)
  
  data_return<-data.frame("name"=all_name,"value"=all_value)
  return(data_return)
}
```

## 根据电影公司搜索电影
```{r}
# 用Rselenium爬取电影的url
library(seleniumPipes)
library(rvest)
library(dplyr)
library(stringi)
library(purrr)

# 启动
# 新建一个session
remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
remDr %>% go("http://www.imdb.com/")
# 搜索结果保存

# 搜索第一部电影
input_company<- remDr %>% findElement("xpath",'//*[@id="navbar-query"]')
input_company %>% elementSendKeys(name_of_banner[1])

# 选择公司作为搜索条件
click_company<- remDr %>% findElement("xpath",'//*[@id="quicksearch"]/option[@value="co"]')
click_company %>% elementClick()

#提交搜索
click<-remDr %>% findElement("xpath",'//*[@id="navbar-submit-button"]')
click %>% elementClick()

#点击搜索结果第一家公司
click_two<-remDr %>% findElement('xpath','//*[@id="main"]/div/div[2]/table/tbody/tr[1]/td/a')
click_two %>% elementClick()

# 下载当前界面
remDr %>% getPageSource() -> banner_page

# 找到该公司的所有电影
company_movie_url<-banner_page %>% html_nodes('#outerbody > tbody > tr > td > table > tbody > tr > td:nth-child(1) > ol > li > a') %>% html_attr('href')
# 下一家公司查找
# company_movie_url<-NULL
for(i in 1:length(name_of_banner)){
  
  #输入搜索条件
  input_company_next<-try(remDr %>% findElement("xpath",'//*[@id="navbar-query"]'))
  if(inherits(input_company,'try-error')){
    remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
    remDr %>% go("http://www.imdb.com/")
    input_company_next<-remDr %>% findElement("xpath",'//*[@id="navbar-query"]')
  }
  # 先清空搜索栏
  input_company_next %>% elementClear()
  input_company_next %>% elementSendKeys(name_of_banner[i])
  
  # 选择公司作为搜索条件
  click_company<- remDr %>% findElement("xpath",'//*[@id="quicksearch"]/option[@value="co"]')
  click_company %>% elementClick()
  
  #提交搜索
  click<-remDr %>% findElement("xpath",'//*[@id="navbar-submit-button"]')
  click %>% elementClick()
  
  # 判断是否有搜索结果
  click_two_judge<-remDr %>% findElements('xpath','//*[@id="main"]/div/div[2]/table/tbody/tr[1]/td/a')
  if(length(click_two_judge)!=0){
    #点击搜索结果第一条
    click_two<-remDr %>% findElement('xpath','//*[@id="main"]/div/div[2]/table/tbody/tr[1]/td/a')
    click_two %>% elementClick()
    
    # 下载当前界面
    remDr %>% getPageSource() -> banner_page
    
    # 找到该公司的所有电影
    company_movie_url_temp<-banner_page %>% html_nodes('#outerbody > tbody > tr > td > table > tbody > tr > td:nth-child(1) > ol > li > a') %>% html_attr('href')
    
    company_movie_url<-c(company_movie_url,company_movie_url_temp)
  }
  cat(i,'\n')
}
remDr %>% deleteSession()

save.image('20170408.RData')

full_movie_url<-paste("http://www.imdb.com",company_movie_url,sep='')
full_movie_url<-full_movie_url[!duplicated(full_movie_url)]
# save.image("20170408.RData")
```
## 搜索电影，合并结果
```{r}
IDMbData<-run_IMDb(full_movie_url[8])
for(i in 9:length(full_movie_url)){
  # 判断是否出错
  processData<-try(run_IMDb(full_movie_url[i]))
  # 如果出错则去除
  if(!inherits(processData,'try-error')){
    IDMbData<-merge(IDMbData,processData,by="name",all=TRUE)
  }
  cat(i,"\n")
  save(IDMbData,file="IDMbData.Rdata")
}
write.csv(IDMbData,file="IDMbData.csv",row.names = FALSE)
```

# 数据清洗
## 清洗BOI的数据
```{r}
# 清洗数据BOI
load("~/R-program/movieData/finalData.Rdata")
load("~/R-program/movieData/IDMbData.Rdata")

finalData<-data.frame(lapply(finalData, as.character), stringsAsFactors=FALSE)
IDMbData<-data.frame(lapply(IDMbData, as.character), stringsAsFactors=FALSE)

# 处理boi的数据
data_boi<-finalData
data_imdb<-IDMbData

data_boi<-t(data_boi)
data_imdb<-t(data_imdb)

rownames(data_boi)<-data_boi[,which(data_boi["name",]=="Movie")]
rownames(data_boi)[1]<-"Item"
colnames(data_boi)<-data_boi["Item",]

# 分割cast
cast_location<-2
cast_matrix<-matrix(NA,nrow = nrow(data_boi),ncol=100)
data_boi<-data_boi[-1,]
cast_boi<-data_boi[,"cast"]
# cast_matrix[1,]<-c(1,2)
## 写一个分割函数
# sepFun<-function(sepElement,sepUnit,maxLen){
#   result_matrix()
# }
cast_matrix<-matrix(NA,nrow = nrow(data_boi),ncol=100)
for(i in 1:length(cast_boi)){
  cast_one<-cast_boi[i]
  cast_sep<-unlist(strsplit(cast_one,split = ','))
  cast_matrix[i,1:length(cast_sep)]<-cast_sep
}
cast_matrix<-cast_matrix[,colSums(is.na(cast_matrix))!=nrow(cast_matrix)]
colnames(cast_matrix)<-paste("cast",1:ncol(cast_matrix),sep='')

## 分割Total Nett和share
Total_share<-data_boi[,3]
assign(paste("valueSep","1",sep=''),matrix(NA,nrow=length(Total_share),ncol=2))
for(i in 1:length(Total_share)){
  toSep<-Total_share[i]
  SepRes<-unlist(strsplit(toSep,split='[|]|:'))
  valueSep[i,1]<-SepRes[2]
  valueSep[i,2]<-SepRes[4]
}
valueSep<-gsub(' ',"",valueSep)

## 票房清洗
box_office_location<-3:20
data_boi_colname<-colnames(data_boi)

data_box_office<-NULL
for(j in 3:20){
  # j=3
  Total_share<-data_boi[,j]
  var_name<-data_boi_colname[j]
  valueSep<-matrix(NA,nrow=length(Total_share),ncol=2)
  for(i in 1:length(Total_share)){
    toSep<-Total_share[i]
    SepRes<-unlist(strsplit(toSep,split='[|]|:'))
    valueSep[i,1]<-SepRes[2]
    valueSep[i,2]<-SepRes[4]
  }
  valueSep<-gsub(' ',"",valueSep)
  name_collection<-c(SepRes[1],SepRes[3])
  colnames(valueSep)<-paste(var_name,name_collection)
  data_box_office<-cbind(data_box_office,valueSep)
}

# 导演等清洗
var_location<-c(21,22,28,30,37,38,42,44)
director_matrix<-NULL
for(j in var_location){
  dialogue_matrix<-matrix(NA,nrow = nrow(data_boi),ncol=100)
  data_dialogue<-data_boi[,j]
  var_name<-data_boi_colname[j]
  for(i in 1:length(data_dialogue)){
    dialogue_one<-data_dialogue[i]
    dialogue_sep<-unlist(strsplit(dialogue_one,split = ','))
    dialogue_sep[dialogue_sep==""| dialogue_sep==" "]<-NA
    dialogue_sep<-na.omit(dialogue_sep)
    if(length(dialogue_sep)!=0){
      dialogue_matrix[i,1:length(dialogue_sep)]<-dialogue_sep
    }
  }
  dialogue_matrix<-dialogue_matrix[,colSums(is.na(dialogue_matrix))!=nrow(dialogue_matrix)]
  
  colnames(dialogue_matrix)<-paste(var_name,1:ncol(dialogue_matrix),sep='')
  director_matrix<-cbind(director_matrix,dialogue_matrix)
}

#删除分割的行
all_location<-c(cast_location,box_office_location,var_location)

data_boi_clean<-data_boi[,-all_location]
data_boi_clean<-cbind(data_boi_clean,cast_matrix,data_box_office,director_matrix)

save(data_boi_clean,file="data_boi_clean.RData")
write.table(data_boi_clean,file = 'data_boi_clean.txt',quote = FALSE,sep = '\t')
```
## 合并BOI数据和IMDB数据

## 按照BOI的actor，actress，director和banner爬取数据
因为按照banner爬取，大概只有800部电影左右。所以想的是按照BOI上面所有分类爬一下电影，然后合并，电影的总数目为1659条
```{r}
# find all the movie on the boi

###### hit_banner#######
# banner_url<-'http://www.boxofficeindia.com/hit-count-banner.php'
url_all<-c("http://www.boxofficeindia.com/hit-count-actor.php",
           "http://www.boxofficeindia.com/hit-count-actress.php",
           "http://www.boxofficeindia.com/hit-count-director.php",
           "http://www.boxofficeindia.com/hit-count-banner.php",
           "http://www.boxofficeindia.com/success-count-actor.php",
           "http://www.boxofficeindia.com/success-count-actress.php",
           "http://www.boxofficeindia.com/success-count-director.php",
           "http://www.boxofficeindia.com/success-count-banner.php")
library(seleniumPipes)
library(rvest)
library(dplyr)
library(stringi)
library(purrr)
remDr  <- remoteDr(port=4444,browserName='chrome',platform='ANY')
boi_movie_url<-NULL
for(banner_url in url_all){
  remDr %>% go(banner_url)
  remDr %>% getPageSource() -> web_banner
  url_banner_alone<-web_banner %>% html_nodes("#yeartopim4 > table > tbody > tr > td > table > tbody > tr > td > a") %>% html_attr("href")
  
  url_banner_alone<-url_banner_alone[!duplicated(url_banner_alone)]
  
  url_banner_alone<-paste("http://www.boxofficeindia.com/",url_banner_alone,sep="")
  
  # 找到所有的电影
  movie_url_all<-NULL
  for(i in 1:length(url_banner_alone)){
    web_banner_test<-url_banner_alone[i]
    web_banner_alone<-read_html(web_banner_test)
    movie_url<-web_banner_alone %>% html_nodes("tr > td:nth-child(2) > a") %>% html_attr('href')
    movie_url_all<-c(movie_url_all,movie_url)
  }
  # 去掉重复的电影
  movie_url_all<-movie_url_all[!duplicated(movie_url_all)]
  movie_url_all<-paste("http://www.boxofficeindia.com/",movie_url_all,sep="")
  boi_movie_url<-c(boi_movie_url,movie_url_all)
}
save(boi_movie_url,file="boi_movie_url.RData")
remDr %>% deleteSession()
boi_movie_url_dup<-boi_movie_url[!duplicated(boi_movie_url)]
save(boi_movie_url_dup,file="boi_movie_url_dup.RData")
```

## 清洗IMDB数据
```{r}
load("~/R-program/movieData/IDMbData.Rdata")

IDMbData<-data.frame(lapply(IDMbData, as.character), stringsAsFactors=FALSE)

# 处理boi的数据
data_imdb<-IDMbData
data_imdb<-t(data_imdb)

rownames(data_imdb)<-data_imdb[,which(data_imdb["name",]=="Movie")]
rownames(data_imdb)[1]<-"Item"
colnames(data_imdb)<-data_imdb["Item",]


### all the cast
cast_location<-c(1,49,52,58)
cast_all<-data_imdb[,cast_location]
# cast_all<-na.omit(cast_all)
cast_imdb<-rep(NA,n=nrow(cast_all))
for(i in 1:nrow(data_imdb)){
  if(sum(!is.na(cast_all[i,]))!=0)
  cast_imdb[i]<-cast_all[i,!is.na(cast_all[i,])]
}

imdb_cast_matrix<-matrix(NA,nrow = nrow(data_imdb),ncol=550)
for(i in 1:length(cast_imdb)){
  cast_one<-cast_imdb[i]
  cast_sep<-unlist(strsplit(cast_one,split = ','))
  if(length(cast_sep)!=0){
    imdb_cast_matrix[i,1:length(cast_sep)]<-cast_sep
  }
}
imdb_cast_matrix<-imdb_cast_matrix[,colSums(is.na(imdb_cast_matrix))!=nrow(imdb_cast_matrix)]
colnames(imdb_cast_matrix)<-paste("cast",1:ncol(imdb_cast_matrix),sep='')
# 分割逗号分隔符
var_location<-c(13,17:23,27:33,35:39,41:48,50:51)
data_imdb_colname<-colnames(data_imdb)

director_matrix<-NULL
for(j in var_location){
  dialogue_matrix<-matrix(NA,nrow = nrow(data_imdb),ncol=700)
  data_dialogue<-data_imdb[,j]
  var_name<-data_imdb_colname[j]
  for(i in 1:length(data_dialogue)){
    dialogue_one<-data_dialogue[i]
    dialogue_sep<-unlist(strsplit(dialogue_one,split = ','))
    dialogue_sep[dialogue_sep==""| dialogue_sep==" "]<-NA
    dialogue_sep<-na.omit(dialogue_sep)
    if(length(dialogue_sep)!=0){
      dialogue_matrix[i,1:length(dialogue_sep)]<-dialogue_sep
    }
  }
  dialogue_matrix<-dialogue_matrix[,colSums(is.na(dialogue_matrix))!=nrow(dialogue_matrix)]
  colnames(dialogue_matrix)<-paste(var_name,1:ncol(dialogue_matrix),sep='')
  director_matrix<-cbind(director_matrix,dialogue_matrix)
}

## Genres
genres_location<-24
genres<-data_imdb[,24]
genres_matrix<-matrix(NA,nrow = nrow(data_imdb),ncol=10)
for(i in 1:length(genres)){
  genres_to_sep<-genres[i]
  genres_sep<-unlist(strsplit(genres_to_sep,split = '[|]'))
  genres_matrix[i,1:length(genres_sep)]<-genres_sep
}
genres_matrix<-genres_matrix[,colSums(is.na(genres_matrix))!=nrow(genres_matrix)]
colnames(genres_matrix)<-paste("Genres",1:ncol(genres_matrix),sep='')

all_locaton<-c(cast_location,var_location,genres_location)
data_imdb_clean<-data_imdb[,-all_locaton]
data_imdb_clean<-cbind(data_imdb_clean,imdb_cast_matrix,director_matrix,genres_matrix)
save(data_imdb_clean,file="data_imdb_clean.RData")
write.table(data_imdb_clean,file = 'data_imdb_clean.txt',quote = FALSE,sep = '\t')
write.csv(data_imdb_clean,file = "data_clean_imdb.csv",quote=FALSE)
```

